import{M as j}from"./index-d38bc732.js";import"./_commonjsHelpers-de833af9.js";const{addons:U}=__STORYBOOK_MODULE_PREVIEW_API__,{once:B,logger:M}=__STORYBOOK_MODULE_CLIENT_LOGGER__,{FORCE_REMOUNT:m,STORY_RENDER_PHASE_CHANGED:P,SET_CURRENT_STORY:Y,IGNORED_EXCEPTION:x}=__STORYBOOK_MODULE_CORE_EVENTS__,{global:p}=__STORYBOOK_MODULE_GLOBAL__;var K=(e=>(e.DONE="done",e.ERROR="error",e.ACTIVE="active",e.WAITING="waiting",e))(K||{}),g={CALL:"storybook/instrumenter/call",SYNC:"storybook/instrumenter/sync",START:"storybook/instrumenter/start",BACK:"storybook/instrumenter/back",GOTO:"storybook/instrumenter/goto",NEXT:"storybook/instrumenter/next",END:"storybook/instrumenter/end"},b={start:!1,back:!1,goto:!1,next:!1,end:!1},w=new Error("This function ran after the play function completed. Did you forget to `await` it?"),I=e=>Object.prototype.toString.call(e)==="[object Object]",G=e=>Object.prototype.toString.call(e)==="[object Module]",$=e=>{if(!I(e)&&!G(e))return!1;if(e.constructor===void 0)return!0;let t=e.constructor.prototype;return!(!I(t)||Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")===!1)},V=e=>{try{return new e.constructor}catch{return{}}},E=()=>({renderPhase:void 0,isDebugging:!1,isPlaying:!1,isLocked:!1,cursor:0,calls:[],shadowCalls:[],callRefsByResult:new Map,chainedCallIds:new Set,ancestors:[],playUntil:void 0,resolvers:{},syncTimeout:void 0}),N=(e,t=!1)=>{let o=(t?e.shadowCalls:e.calls).filter(i=>i.retain);if(!o.length)return;let l=new Map(Array.from(e.callRefsByResult.entries()).filter(([,i])=>i.retain));return{cursor:o.length,calls:o,callRefsByResult:l}},k=class{constructor(){this.initialized=!1,this.channel=U.getChannel(),this.state=p.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__||{};let e=({storyId:s,isPlaying:r=!0,isDebugging:n=!1})=>{let a=this.getState(s);this.setState(s,{...E(),...N(a,n),shadowCalls:n?a.shadowCalls:[],chainedCallIds:n?a.chainedCallIds:new Set,playUntil:n?a.playUntil:void 0,isPlaying:r,isDebugging:n}),this.sync(s)};this.channel.on(m,e),this.channel.on(P,({storyId:s,newPhase:r})=>{let{isDebugging:n}=this.getState(s);this.setState(s,{renderPhase:r}),r==="preparing"&&n&&e({storyId:s}),r==="playing"&&e({storyId:s,isDebugging:n}),r==="played"&&this.setState(s,{isLocked:!1,isPlaying:!1,isDebugging:!1}),r==="errored"&&this.setState(s,{isLocked:!1,isPlaying:!1})}),this.channel.on(Y,()=>{this.initialized?this.cleanup():this.initialized=!0});let t=({storyId:s,playUntil:r})=>{this.getState(s).isDebugging||this.setState(s,({calls:a})=>({calls:[],shadowCalls:a.map(_=>({..._,status:"waiting"})),isDebugging:!0}));let n=this.getLog(s);this.setState(s,({shadowCalls:a})=>{var d;if(r||!n.length)return{playUntil:r};let _=a.findIndex(h=>h.id===n[0].callId);return{playUntil:(d=a.slice(0,_).filter(h=>h.interceptable&&!h.ancestors.length).slice(-1)[0])==null?void 0:d.id}}),this.channel.emit(m,{storyId:s,isDebugging:!0})},o=({storyId:s})=>{var a;let r=this.getLog(s).filter(_=>!_.ancestors.length),n=r.reduceRight((_,d,h)=>_>=0||d.status==="waiting"?_:h,-1);t({storyId:s,playUntil:(a=r[n-1])==null?void 0:a.callId})},l=({storyId:s,callId:r})=>{var O;let{calls:n,shadowCalls:a,resolvers:_}=this.getState(s),d=n.find(({id:u})=>u===r),h=a.find(({id:u})=>u===r);if(!d&&h&&Object.values(_).length>0){let u=(O=this.getLog(s).find(f=>f.status==="waiting"))==null?void 0:O.callId;h.id!==u&&this.setState(s,{playUntil:h.id}),Object.values(_).forEach(f=>f())}else t({storyId:s,playUntil:r})},i=({storyId:s})=>{var n;let{resolvers:r}=this.getState(s);if(Object.values(r).length>0)Object.values(r).forEach(a=>a());else{let a=(n=this.getLog(s).find(_=>_.status==="waiting"))==null?void 0:n.callId;a?t({storyId:s,playUntil:a}):c({storyId:s})}},c=({storyId:s})=>{this.setState(s,{playUntil:void 0,isDebugging:!1}),Object.values(this.getState(s).resolvers).forEach(r=>r())};this.channel.on(g.START,t),this.channel.on(g.BACK,o),this.channel.on(g.GOTO,l),this.channel.on(g.NEXT,i),this.channel.on(g.END,c)}getState(e){return this.state[e]||E()}setState(e,t){let o=this.getState(e),l=typeof t=="function"?t(o):t;this.state={...this.state,[e]:{...o,...l}},p.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}cleanup(){this.state=Object.entries(this.state).reduce((t,[o,l])=>{let i=N(l);return i&&(t[o]=Object.assign(E(),i)),t},{});let e={controlStates:b,logItems:[]};this.channel.emit(g.SYNC,e),p.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}getLog(e){let{calls:t,shadowCalls:o}=this.getState(e),l=[...o];t.forEach((c,s)=>{l[s]=c});let i=new Set;return l.reduceRight((c,s)=>(s.args.forEach(r=>{r!=null&&r.__callId__&&i.add(r.__callId__)}),s.path.forEach(r=>{r.__callId__&&i.add(r.__callId__)}),(s.interceptable||s.exception)&&!i.has(s.id)&&(c.unshift({callId:s.id,status:s.status,ancestors:s.ancestors}),i.add(s.id)),c),[])}instrument(e,t){if(!$(e))return e;let{mutate:o=!1,path:l=[]}=t;return Object.keys(e).reduce((i,c)=>{let s=e[c];return typeof s!="function"?(i[c]=this.instrument(s,{...t,path:l.concat(c)}),i):typeof s.__originalFn__=="function"?(i[c]=s,i):(i[c]=(...r)=>this.track(c,s,r,t),i[c].__originalFn__=s,Object.defineProperty(i[c],"name",{value:c,writable:!1}),Object.keys(s).length>0&&Object.assign(i[c],this.instrument({...s},{...t,path:l.concat(c)})),i)},o?e:V(e))}track(e,t,o,l){var u,f,S,T;let i=((u=o==null?void 0:o[0])==null?void 0:u.__storyId__)||((T=(S=(f=p.__STORYBOOK_PREVIEW__)==null?void 0:f.selectionStore)==null?void 0:S.selection)==null?void 0:T.storyId),{cursor:c,ancestors:s}=this.getState(i);this.setState(i,{cursor:c+1});let r=`${s.slice(-1)[0]||i} [${c}] ${e}`,{path:n=[],intercept:a=!1,retain:_=!1}=l,d=typeof a=="function"?a(e,n):a,h={id:r,cursor:c,storyId:i,ancestors:s,path:n,method:e,args:o,interceptable:d,retain:_},O=(d&&!s.length?this.intercept:this.invoke).call(this,t,h,l);return this.instrument(O,{...l,mutate:!0,path:[{__callId__:h.id}]})}intercept(e,t,o){let{chainedCallIds:l,isDebugging:i,playUntil:c}=this.getState(t.storyId),s=l.has(t.id);return!i||s||c?(c===t.id&&this.setState(t.storyId,{playUntil:void 0}),this.invoke(e,t,o)):new Promise(r=>{this.setState(t.storyId,({resolvers:n})=>({isLocked:!1,resolvers:{...n,[t.id]:r}}))}).then(()=>(this.setState(t.storyId,r=>{let{[t.id]:n,...a}=r.resolvers;return{isLocked:!0,resolvers:a}}),this.invoke(e,t,o)))}invoke(e,t,o){let{callRefsByResult:l,renderPhase:i}=this.getState(t.storyId),c=n=>{var a,_;if(l.has(n))return l.get(n);if(n instanceof Array)return n.map(c);if(n instanceof Date)return{__date__:{value:n.toISOString()}};if(n instanceof Error){let{name:d,message:h,stack:O}=n;return{__error__:{name:d,message:h,stack:O}}}if(n instanceof RegExp){let{flags:d,source:h}=n;return{__regexp__:{flags:d,source:h}}}if(n instanceof p.window.HTMLElement){let{prefix:d,localName:h,id:O,classList:u,innerText:f}=n,S=Array.from(u);return{__element__:{prefix:d,localName:h,id:O,classNames:S,innerText:f}}}return typeof n=="function"?{__function__:{name:n.name}}:typeof n=="symbol"?{__symbol__:{description:n.description}}:typeof n=="object"&&((a=n==null?void 0:n.constructor)!=null&&a.name)&&((_=n==null?void 0:n.constructor)==null?void 0:_.name)!=="Object"?{__class__:{name:n.constructor.name}}:Object.prototype.toString.call(n)==="[object Object]"?Object.fromEntries(Object.entries(n).map(([d,h])=>[d,c(h)])):n},s={...t,args:t.args.map(c)};t.path.forEach(n=>{n!=null&&n.__callId__&&this.setState(t.storyId,({chainedCallIds:a})=>({chainedCallIds:new Set(Array.from(a).concat(n.__callId__))}))});let r=n=>{if(n instanceof Error){let{name:a,message:_,stack:d,callId:h=t.id}=n,O={name:a,message:_,stack:d,callId:h};if(this.update({...s,status:"error",exception:O}),this.setState(t.storyId,u=>({callRefsByResult:new Map([...Array.from(u.callRefsByResult.entries()),[n,{__callId__:t.id,retain:t.retain}]])})),t.ancestors.length)throw Object.prototype.hasOwnProperty.call(n,"callId")||Object.defineProperty(n,"callId",{value:t.id}),n;if(n!==w)throw M.warn(n),x}throw n};try{if(i==="played"&&!t.retain)throw w;let n=(o.getArgs?o.getArgs(t,this.getState(t.storyId)):t.args).map(_=>typeof _!="function"||Object.keys(_).length?_:(...d)=>{let{cursor:h,ancestors:O}=this.getState(t.storyId);this.setState(t.storyId,{cursor:0,ancestors:[...O,t.id]});let u=()=>this.setState(t.storyId,{cursor:h,ancestors:O}),f=!1;try{let S=_(...d);return S instanceof Promise?(f=!0,S.finally(u)):S}finally{f||u()}}),a=e(...n);return a&&["object","function","symbol"].includes(typeof a)&&this.setState(t.storyId,_=>({callRefsByResult:new Map([...Array.from(_.callRefsByResult.entries()),[a,{__callId__:t.id,retain:t.retain}]])})),this.update({...s,status:a instanceof Promise?"active":"done"}),a instanceof Promise?a.then(_=>(this.update({...s,status:"done"}),_),r):a}catch(n){return r(n)}}update(e){this.channel.emit(g.CALL,e),this.setState(e.storyId,({calls:t})=>{let o=t.concat(e).reduce((l,i)=>Object.assign(l,{[i.id]:i}),{});return{calls:Object.values(o).sort((l,i)=>l.id.localeCompare(i.id,void 0,{numeric:!0}))}}),this.sync(e.storyId)}sync(e){let t=()=>{var a;let{isLocked:o,isPlaying:l}=this.getState(e),i=this.getLog(e),c=(a=i.filter(({ancestors:_})=>!_.length).find(_=>_.status==="waiting"))==null?void 0:a.callId,s=i.some(_=>_.status==="active");if(o||s||i.length===0){let _={controlStates:b,logItems:i};this.channel.emit(g.SYNC,_);return}let r=i.some(_=>_.status==="done"||_.status==="error"),n={controlStates:{start:r,back:r,goto:!0,next:l,end:l},logItems:i,pausedAt:c};this.channel.emit(g.SYNC,n)};this.setState(e,({syncTimeout:o})=>(clearTimeout(o),{syncTimeout:setTimeout(t,0)}))}};function D(e,t={}){var o,l,i,c;try{let s=!1,r=!1;return(l=(o=p.window.location)==null?void 0:o.search)!=null&&l.includes("instrument=true")?s=!0:(c=(i=p.window.location)==null?void 0:i.search)!=null&&c.includes("instrument=false")&&(r=!0),p.window.parent===p.window&&!s||r?e:(p.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__||(p.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__=new k),p.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__.instrument(e,t))}catch(s){return B.warn(s),e}}const{addons:F}=__STORYBOOK_MODULE_PREVIEW_API__,{global:H}=__STORYBOOK_MODULE_GLOBAL__,{FORCE_REMOUNT:z,STORY_RENDER_PHASE_CHANGED:W}=__STORYBOOK_MODULE_CORE_EVENTS__;var A=new j(H),X=A.fn.bind(A),{action:J}=D({action:X},{retain:!0}),L=F.getChannel(),C=new Set,y=[];L.on(z,()=>y.forEach(e=>{var t;return(t=e==null?void 0:e.mockClear)==null?void 0:t.call(e)}));L.on(W,({newPhase:e})=>{e==="loading"&&y.forEach(t=>{var o;return(o=t==null?void 0:t.mockClear)==null?void 0:o.call(t)})});var R=(e,t,o)=>{if(C.has(t))return t;C.add(t);try{if(Object.prototype.toString.call(t)==="[object Object]"){for(let[l,i]of Object.entries(t))t[l]=R(e,i,l);return t}if(Array.isArray(t))return t.map((l,i)=>R(e,l,`${o}[${i}]`));if(typeof t=="function"&&t.isAction){Object.defineProperty(t,"name",{value:o,writable:!1}),Object.defineProperty(t,"__storyId__",{value:e,writable:!1});let l=J(t);return y.push(l),l}}catch{}return t},q=({id:e,initialArgs:t})=>R(e,t),v=[q],{step:tt}=D({step:(e,t,o)=>t(o)},{intercept:!0}),et={throwPlayFunctionExceptions:!1};export{v as argsEnhancers,et as parameters,tt as runStep};
//# sourceMappingURL=preview-124c01db.js.map
